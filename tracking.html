<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡ - CarGo</title>
    <!-- Google Maps JavaScript API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .tracking-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1rem;
            height: calc(100vh - 100px);
        }

        .map-section {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        .map-container {
            width: 100%;
            height: 100%;
            background: #e8f4f8;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #7f8c8d;
        }

        .fallback-map {
            width: 100%;
            height: 100%;
            background: #e8f4f8;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #7f8c8d;
        }

        .vehicle-marker {
            position: absolute;
            top: 45%;
            left: 55%;
            font-size: 2rem;
            z-index: 10;
            animation: moveVehicle 8s infinite linear;
        }

        @keyframes moveVehicle {
            0% { top: 45%; left: 55%; }
            25% { top: 40%; left: 60%; }
            50% { top: 35%; left: 65%; }
            75% { top: 30%; left: 70%; }
            100% { top: 45%; left: 55%; }
        }

        .route-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 48%, #3498db 49%, #3498db 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, #3498db 49%, #3498db 51%, transparent 52%);
            background-size: 20px 20px;
            opacity: 0.3;
            pointer-events: none;
        }

        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .info-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: #34495e;
            color: white;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .job-summary {
            background: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .job-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .job-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .progress-section {
            margin-bottom: 1.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .eta-display {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
        }

        .eta-time {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .location-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .location-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
        }

        .location-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
        }

        .start-location { background: #3498db; }
        .current-location { background: #f39c12; }
        .end-location { background: #27ae60; }

        .tracking-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .log-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            font-size: 0.8rem;
            color: #7f8c8d;
            min-width: 60px;
        }

        .log-icon {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
        }

        .log-pickup { background: #3498db; }
        .log-checkpoint { background: #f39c12; }
        .log-delivery { background: #27ae60; }
        .log-warning { background: #e74c3c; }

        .alert-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .alert-title {
            font-weight: bold;
            color: #b7950b;
            margin-bottom: 0.5rem;
        }

        .speed-monitor {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .speed-display {
            font-size: 2rem;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 0.5rem;
        }

        .emergency-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s;
        }

        .emergency-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .contact-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .contact-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .contact-shipper {
            background: #3498db;
            color: white;
        }

        .contact-driver {
            background: #27ae60;
            color: white;
        }

        .contact-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 400px 1fr;
                height: auto;
            }
            
            .info-panel {
                max-height: 500px;
            }
            
            .map-controls {
                top: 0.5rem;
                right: 0.5rem;
            }
            
            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">ğŸ—ºï¸ CarGo ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡</div>
            <div class="tracking-status">
                <div class="status-dot"></div>
                <span>è¿½è·¡ä¸­</span>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- åœ°å›³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="map-section">
            <!-- Google Mapsè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="map"></div>
            
            <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆAPIã‚­ãƒ¼ãŒç„¡ã„å ´åˆï¼‰ -->
            <div id="fallback-map" class="fallback-map" style="display: none;">
                <div class="route-line"></div>
                <div class="vehicle-marker">ğŸš—</div>
                <div style="position: absolute; top: 20%; left: 20%; font-size: 1.5rem;">ğŸ“ é–‹å§‹åœ°ç‚¹</div>
                <div style="position: absolute; bottom: 20%; right: 20%; font-size: 1.5rem;">ğŸ ç›®çš„åœ°</div>
                <div style="text-align: center;">
                    <h3>ğŸ—ºï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ°å›³</h3>
                    <p>Google Maps API ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</p>
                    <small style="color: #95a5a6;">APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨å®Ÿéš›ã®åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                </div>
            </div>
            
            <div class="map-controls">
                <button class="control-btn" onclick="centerMap()" title="ç¾åœ¨ä½ç½®ã«ç§»å‹•">ğŸ“</button>
                <button class="control-btn" onclick="zoomIn()" title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³">+</button>
                <button class="control-btn" onclick="zoomOut()" title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ">-</button>
                <button class="control-btn" onclick="toggleFullscreen()" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³">â›¶</button>
            </div>
        </div>

        <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
        <div class="info-panel">
            <div class="panel-header">ğŸ“‹ è¼¸é€æƒ…å ±</div>
            <div class="panel-content">
                <!-- æ¡ˆä»¶ã‚µãƒãƒªãƒ¼ -->
                <div class="job-summary">
                    <div class="job-title">ãƒˆãƒ¨ã‚¿ ãƒ—ãƒªã‚¦ã‚¹ 2019å¹´</div>
                    <div class="job-detail">
                        <span><strong>æ¡ˆä»¶ID:</strong></span>
                        <span>JOB001</span>
                    </div>
                    <div class="job-detail">
                        <span><strong>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼:</strong></span>
                        <span>å±±ç”°å¤ªéƒ</span>
                    </div>
                    <div class="job-detail">
                        <span><strong>å ±é…¬:</strong></span>
                        <span>Â¥35,000</span>
                    </div>
                </div>

                <!-- é€²æ—è¡¨ç¤º -->
                <div class="progress-section">
                    <div class="progress-header">
                        <strong>è¼¸é€é€²æ—</strong>
                        <span id="progressPercent">65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 65%;"></div>
                    </div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        æ®‹ã‚Šè·é›¢: <span id="remainingDistance">15.2km</span>
                    </div>
                </div>

                <!-- åˆ°ç€äºˆå®šæ™‚åˆ» -->
                <div class="eta-display">
                    <div class="eta-time" id="etaTime">15:30</div>
                    <div>äºˆå®šåˆ°ç€æ™‚åˆ»</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                        ã‚ã¨ <span id="timeRemaining">23åˆ†</span>
                    </div>
                </div>

                <!-- ä½ç½®æƒ…å ± -->
                <div class="location-info">
                    <h4 style="margin-bottom: 0.5rem;">ğŸ“ ãƒ«ãƒ¼ãƒˆæƒ…å ±</h4>
                    
                    <div class="location-item">
                        <div class="location-icon start-location">å‡º</div>
                        <div>
                            <strong>å‡ºç™ºåœ°</strong><br>
                            <small>æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1</small>
                        </div>
                    </div>
                    
                    <div class="location-item">
                        <div class="location-icon current-location">ç¾</div>
                        <div>
                            <strong>ç¾åœ¨ä½ç½®</strong><br>
                            <small id="currentLocation">æ±äº¬éƒ½å“å·åŒºæ±å“å·2-3-12</small>
                        </div>
                    </div>
                    
                    <div class="location-item">
                        <div class="location-icon end-location">ç€</div>
                        <div>
                            <strong>ç›®çš„åœ°</strong><br>
                            <small>ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚è¥¿åŒºã¿ãªã¨ã¿ã‚‰ã„1-1-1</small>
                        </div>
                    </div>
                </div>

                <!-- é€Ÿåº¦ç›£è¦– -->
                <div class="speed-monitor">
                    <div class="speed-display" id="currentSpeed">52</div>
                    <div>ç¾åœ¨é€Ÿåº¦ (km/h)</div>
                    <div style="font-size: 0.8rem; margin-top: 0.5rem; color: #27ae60;">
                        âœ… å®‰å…¨é‹è»¢ä¸­
                    </div>
                </div>

                <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º -->
                <div class="alert-section" id="alertSection" style="display: none;">
                    <div class="alert-title">âš ï¸ æ³¨æ„äº‹é …</div>
                    <div id="alertMessage">é€Ÿåº¦åˆ¶é™ã‚’è¶…éã—ã¦ã„ã¾ã™</div>
                </div>

                <!-- è¿½è·¡ãƒ­ã‚° -->
                <div class="tracking-log">
                    <h4 style="margin-bottom: 0.5rem;">ğŸ“ è¿½è·¡ãƒ­ã‚°</h4>
                    
                    <div class="log-item">
                        <div class="log-time">15:07</div>
                        <div class="log-icon log-checkpoint">ğŸš—</div>
                        <div>ç’°ä¸ƒé€šã‚Šé€šé</div>
                    </div>
                    
                    <div class="log-item">
                        <div class="log-time">14:45</div>
                        <div class="log-icon log-checkpoint">ğŸ“</div>
                        <div>ä¸­é–“åœ°ç‚¹åˆ°é”</div>
                    </div>
                    
                    <div class="log-item">
                        <div class="log-time">14:20</div>
                        <div class="log-icon log-pickup">âœ…</div>
                        <div>è»Šä¸¡å—å–å®Œäº†ãƒ»è¼¸é€é–‹å§‹</div>
                    </div>
                    
                    <div class="log-item">
                        <div class="log-time">14:15</div>
                        <div class="log-icon log-pickup">ğŸ“‹</div>
                        <div>è»Šä¸¡ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</div>
                    </div>
                </div>

                <!-- é€£çµ¡æ©Ÿèƒ½ -->
                <div class="contact-section">
                    <button class="contact-btn contact-shipper" onclick="contactShipper()">ğŸ“ è·ä¸»ã«é€£çµ¡</button>
                    <button class="contact-btn contact-driver" onclick="contactDriver()">ğŸ“ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã«é€£çµ¡</button>
                </div>

                <!-- ç·Šæ€¥é€£çµ¡ãƒœã‚¿ãƒ³ -->
                <button class="emergency-btn" onclick="emergencyContact()">ğŸš¨ ç·Šæ€¥é€£çµ¡</button>
            </div>
        </div>
    </div>

    <script>
        let currentProgress = 65;
        let currentSpeed = 52;
        let alertShown = false;
        let map, vehicleMarker, directionsService, directionsRenderer;
        let routeCoordinates = [];
        let currentPositionIndex = 0;

        // åœ°å›³ã®åˆæœŸåŒ–
        function initMap() {
            // å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã®åº§æ¨™
            const origin = { lat: 35.6894, lng: 139.6917 }; // æ–°å®¿é§…
            const destination = { lat: 35.4647, lng: 139.6224 }; // æ¨ªæµœé§…
            const currentPos = { lat: 35.6580, lng: 139.7016 }; // å“å·é§…ï¼ˆç¾åœ¨ä½ç½®ï¼‰

            try {
                // åœ°å›³ã®ä½œæˆ
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: currentPos,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{ color: '#e9e9e9' }]
                        },
                        {
                            featureType: 'landscape',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });

                // ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã‚µãƒ¼ãƒ“ã‚¹
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    suppressMarkers: false,
                    polylineOptions: {
                        strokeColor: '#3498db',
                        strokeWeight: 5,
                        strokeOpacity: 0.8
                    }
                });
                directionsRenderer.setMap(map);

                // ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ãƒ»è¡¨ç¤º
                calculateAndDisplayRoute(origin, destination);

                // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
                createCustomMarkers(origin, destination, currentPos);

                console.log('Google Maps ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

            } catch (error) {
                console.error('Google Maps ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                showFallbackMap();
            }
        }

        // ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã¨è¡¨ç¤º
        function calculateAndDisplayRoute(origin, destination) {
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                avoidHighways: false,
                avoidTolls: false
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    
                    // ãƒ«ãƒ¼ãƒˆã®åº§æ¨™ã‚’ä¿å­˜ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
                    const route = response.routes[0];
                    routeCoordinates = [];
                    route.legs.forEach(leg => {
                        leg.steps.forEach(step => {
                            routeCoordinates = routeCoordinates.concat(step.path);
                        });
                    });
                    
                    console.log('ãƒ«ãƒ¼ãƒˆãŒè¨ˆç®—ã•ã‚Œã¾ã—ãŸ:', routeCoordinates.length, 'å€‹ã®åº§æ¨™ç‚¹');
                } else {
                    console.error('ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã«å¤±æ•—:', status);
                }
            });
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
        function createCustomMarkers(origin, destination, currentPos) {
            // å‡ºç™ºåœ°ãƒãƒ¼ã‚«ãƒ¼
            new google.maps.Marker({
                position: origin,
                map: map,
                title: 'å‡ºç™ºåœ°: æ±äº¬éƒ½æ–°å®¿åŒº',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="12" fill="#3498db" stroke="white" stroke-width="3"/>
                            <text x="15" y="20" text-anchor="middle" fill="white" font-size="14" font-weight="bold">å‡º</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(30, 30)
                }
            });

            // ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼
            new google.maps.Marker({
                position: destination,
                map: map,
                title: 'ç›®çš„åœ°: ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="15" cy="15" r="12" fill="#27ae60" stroke="white" stroke-width="3"/>
                            <text x="15" y="20" text-anchor="middle" fill="white" font-size="14" font-weight="bold">ç€</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(30, 30)
                }
            });

            // è»Šä¸¡ï¼ˆç¾åœ¨ä½ç½®ï¼‰ãƒãƒ¼ã‚«ãƒ¼
            vehicleMarker = new google.maps.Marker({
                position: currentPos,
                map: map,
                title: 'è»Šä¸¡ç¾åœ¨ä½ç½®',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="35" height="35" viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="17.5" cy="17.5" r="15" fill="#f39c12" stroke="white" stroke-width="3"/>
                            <text x="17.5" y="23" text-anchor="middle" fill="white" font-size="18">ğŸš—</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(35, 35)
                },
                zIndex: 1000
            });

            // è»Šä¸¡ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="font-family: 'Segoe UI', sans-serif; padding: 5px;">
                        <h4 style="margin: 0 0 5px 0; color: #2c3e50;">ğŸš— ãƒˆãƒ¨ã‚¿ ãƒ—ãƒªã‚¦ã‚¹</h4>
                        <p style="margin: 2px 0; font-size: 0.9rem;">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼: å±±ç”°å¤ªéƒ</p>
                        <p style="margin: 2px 0; font-size: 0.9rem;">é€Ÿåº¦: <span id="marker-speed">${currentSpeed}</span> km/h</p>
                        <p style="margin: 2px 0; font-size: 0.9rem;">é€²æ—: <span id="marker-progress">${currentProgress}</span>%</p>
                    </div>
                `
            });

            vehicleMarker.addListener('click', () => {
                // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å†…å®¹ã‚’æœ€æ–°ã«æ›´æ–°
                infoWindow.setContent(`
                    <div style="font-family: 'Segoe UI', sans-serif; padding: 5px;">
                        <h4 style="margin: 0 0 5px 0; color: #2c3e50;">ğŸš— ãƒˆãƒ¨ã‚¿ ãƒ—ãƒªã‚¦ã‚¹</h4>
                        <p style="margin: 2px 0; font-size: 0.9rem;">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼: å±±ç”°å¤ªéƒ</p>
                        <p style="margin: 2px 0; font-size: 0.9rem;">é€Ÿåº¦: ${Math.round(currentSpeed)} km/h</p>
                        <p style="margin: 2px 0; font-size: 0.9rem;">é€²æ—: ${Math.round(currentProgress)}%</p>
                        <p style="margin: 2px 0; font-size: 0.9rem;">æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP')}</p>
                    </div>
                `);
                infoWindow.open(map, vehicleMarker);
            });
        }

        // è»Šä¸¡ä½ç½®ã®æ›´æ–°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function updateVehiclePosition() {
            if (routeCoordinates.length > 0 && vehicleMarker) {
                // é€²æ—ã«åŸºã¥ã„ã¦åº§æ¨™ã‚’è¨ˆç®—
                const progressIndex = Math.floor((currentProgress / 100) * (routeCoordinates.length - 1));
                
                if (progressIndex < routeCoordinates.length) {
                    const newPosition = routeCoordinates[progressIndex];
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ»‘ã‚‰ã‹ã«ç§»å‹•
                    vehicleMarker.setPosition(newPosition);
                    
                    // åœ°å›³ã®ä¸­å¿ƒã‚’è»Šä¸¡ã«åˆã‚ã›ã¦ç§»å‹•ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    // map.panTo(newPosition);
                }
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åœ°å›³ã®è¡¨ç¤º
        function showFallbackMap() {
            document.getElementById('map').style.display = 'none';
            document.getElementById('fallback-map').style.display = 'flex';
            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åœ°å›³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™');
        }

        // åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ï¼ˆGoogle Mapså¯¾å¿œç‰ˆï¼‰
        function centerMap() {
            if (map && vehicleMarker) {
                map.setCenter(vehicleMarker.getPosition());
                map.setZoom(15);
            } else {
                alert('ğŸ“ ç¾åœ¨ä½ç½®ã«åœ°å›³ã‚’ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™');
            }
        }

        function zoomIn() {
            if (map) {
                map.setZoom(map.getZoom() + 1);
            } else {
                alert('ğŸ” åœ°å›³ã‚’ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã—ã¾ã™');
            }
        }

        function zoomOut() {
            if (map) {
                map.setZoom(map.getZoom() - 1);
            } else {
                alert('ğŸ” åœ°å›³ã‚’ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã™');
            }
        }

        // Google Maps APIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.gm_authFailure = function() {
            console.error('Google Maps APIèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            showFallbackMap();
            alert('Google Maps APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚\n\nå®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯æœ‰åŠ¹ãªAPIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        };

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }

        // é€£çµ¡æ©Ÿèƒ½
        function contactShipper() {
            alert('ğŸ“ è·ä¸»ï¼ˆç”°ä¸­å•†ä¼šï¼‰ã«é›»è©±ã‚’ã‹ã‘ã¾ã™\n\nå®Ÿè£…æ™‚ã«ã¯ï¼š\n- VoIPé€šè©±æ©Ÿèƒ½\n- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½\n- ä½ç½®æƒ…å ±å…±æœ‰');
        }

        function contactDriver() {
            alert('ğŸ“ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼ˆå±±ç”°å¤ªéƒï¼‰ã«é›»è©±ã‚’ã‹ã‘ã¾ã™\n\nå®Ÿè£…æ™‚ã«ã¯ï¼š\n- VoIPé€šè©±æ©Ÿèƒ½\n- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½\n- ç·Šæ€¥é€šçŸ¥');
        }

        function emergencyContact() {
            if (confirm('ğŸš¨ ç·Šæ€¥é€£çµ¡ã‚’ç™ºä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\n- è­¦å¯Ÿãƒ»æ¶ˆé˜²ãƒ»æ•‘æ€¥\n- CarGoç·Šæ€¥å¯¾å¿œã‚»ãƒ³ã‚¿ãƒ¼\n- ä¿é™ºä¼šç¤¾')) {
                alert('ğŸš¨ ç·Šæ€¥é€£çµ¡ã‚’ç™ºä¿¡ä¸­...\nç·Šæ€¥å¯¾å¿œãƒãƒ¼ãƒ ã«é€šçŸ¥ã•ã‚Œã¾ã—ãŸ');
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function updateTrackingData() {
            // é€²æ—ã®æ›´æ–°
            currentProgress += 0.5;
            if (currentProgress > 100) currentProgress = 100;
            
            document.getElementById('progressPercent').textContent = Math.round(currentProgress) + '%';
            document.getElementById('progressFill').style.width = currentProgress + '%';
            
            // æ®‹ã‚Šè·é›¢ã®æ›´æ–°
            const remainingDistance = (35 * (100 - currentProgress) / 100).toFixed(1);
            document.getElementById('remainingDistance').textContent = remainingDistance + 'km';
            
            // é€Ÿåº¦ã®æ›´æ–°ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•ï¼‰
            currentSpeed += (Math.random() - 0.5) * 10;
            currentSpeed = Math.max(0, Math.min(80, currentSpeed));
            document.getElementById('currentSpeed').textContent = Math.round(currentSpeed);
            
            // é€Ÿåº¦ã‚¢ãƒ©ãƒ¼ãƒˆ
            if (currentSpeed > 70 && !alertShown) {
                showSpeedAlert();
                alertShown = true;
            } else if (currentSpeed <= 70 && alertShown) {
                hideSpeedAlert();
                alertShown = false;
            }
            
            // ETAæ™‚é–“ã®æ›´æ–°
            const now = new Date();
            const etaMinutes = Math.round((100 - currentProgress) * 0.6);
            const eta = new Date(now.getTime() + etaMinutes * 60000);
            document.getElementById('etaTime').textContent = eta.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('timeRemaining').textContent = etaMinutes + 'åˆ†';
            
            // ç¾åœ¨ä½ç½®ã®æ›´æ–°ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
            const locations = [
                'æ±äº¬éƒ½å“å·åŒºæ±å“å·2-3-12',
                'æ±äº¬éƒ½æ¸¯åŒºèŠæµ¦3-15-6',
                'æ±äº¬éƒ½æ¸¯åŒºå°å ´1-7-1',
                'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚è¥¿åŒºé«˜å³¶2-19-12',
                'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚è¥¿åŒºã¿ãªã¨ã¿ã‚‰ã„1-1-1'
            ];
            const locationIndex = Math.floor(currentProgress / 20);
            if (locations[locationIndex]) {
                document.getElementById('currentLocation').textContent = locations[locationIndex];
            }
            
            // Google Mapsä¸Šã®è»Šä¸¡ä½ç½®ã‚‚æ›´æ–°
            updateVehiclePosition();
        }

        function showSpeedAlert() {
            const alertSection = document.getElementById('alertSection');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = 'åˆ¶é™é€Ÿåº¦ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚å®‰å…¨é‹è»¢ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚';
            alertSection.style.display = 'block';
        }

        function hideSpeedAlert() {
            document.getElementById('alertSection').style.display = 'none';
        }

        // æ–°ã—ã„ãƒ­ã‚°ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
        function addLogItem(time, type, message) {
            const trackingLog = document.querySelector('.tracking-log');
            const newLogItem = document.createElement('div');
            newLogItem.className = 'log-item';
            newLogItem.innerHTML = `
                <div class="log-time">${time}</div>
                <div class="log-icon log-${type}">ğŸ“</div>
                <div>${message}</div>
            `;
            
            // æœ€åˆã®å­è¦ç´ ï¼ˆh4ï¼‰ã®å¾Œã«æŒ¿å…¥
            trackingLog.insertBefore(newLogItem, trackingLog.children[1]);
        }

        // GPSãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function sendGPSData() {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã“ã“ã§GPSåº§æ¨™ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
            console.log('GPS ãƒ‡ãƒ¼ã‚¿é€ä¿¡:', {
                jobId: 'JOB001',
                latitude: 35.6762 + Math.random() * 0.01,
                longitude: 139.6503 + Math.random() * 0.01,
                speed: currentSpeed,
                heading: Math.random() * 360,
                timestamp: new Date().toISOString()
            });
        }

        // WebSocketæ¥ç¶šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function initializeWebSocket() {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€WebSocketã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
            console.log('WebSocketæ¥ç¶šã‚’é–‹å§‹...');
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            setInterval(() => {
                const updates = [
                    'æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’é€šéã—ã¾ã—ãŸ',
                    'é«˜é€Ÿé“è·¯ã«å…¥ã‚Šã¾ã—ãŸ',
                    'ä¼‘æ†©ã‚¨ãƒªã‚¢ã‚’é€šéã—ã¾ã—ãŸ',
                    'ç›®çš„åœ°ã«è¿‘ã¥ã„ã¦ã„ã¾ã™'
                ];
                
                if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡ã§æ–°ã—ã„ãƒ­ã‚°
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    const randomUpdate = updates[Math.floor(Math.random() * updates.length)];
                    addLogItem(timeStr, 'checkpoint', randomUpdate);
                }
            }, 30000); // 30ç§’ã”ã¨
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...');
            
            // Google Maps APIèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’å¾Œã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºï¼‰
            setTimeout(() => {
                if (!map) {
                    console.warn('Google Maps ã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                    showFallbackMap();
                }
            }, 5000);
            
            // å®šæœŸæ›´æ–°ã®é–‹å§‹
            setInterval(updateTrackingData, 2000); // 2ç§’ã”ã¨
            setInterval(sendGPSData, 5000); // 5ç§’ã”ã¨
            
            // WebSocketæ¥ç¶šã®åˆæœŸåŒ–
            initializeWebSocket();
            
            // ä½ç½®æƒ…å ±ã®å–å¾—è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        console.log('ç¾åœ¨ä½ç½®:', position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.warn('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 10000
                    }
                );
            }
        });

        // é€šçŸ¥æ¨©é™ã®è¦æ±‚
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('é€šçŸ¥è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸ');
                }
            });
        }

        // é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®é€šçŸ¥
        function showNotification(title, message) {
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico'
                });
            }
        }

        // ãƒ‡ãƒ¢ç”¨ã®é€šçŸ¥
        setTimeout(() => {
            showNotification('CarGo', 'è»Šä¸¡ãŒä¸­é–“åœ°ç‚¹ã‚’é€šéã—ã¾ã—ãŸ');
        }, 10000);

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'f':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'c':
                        e.preventDefault();
                        centerMap();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                }
            }
        });
    </script>
</body>
</html>